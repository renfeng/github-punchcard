<link rel="import" href="../paper-toast/paper-toast.html"/>
<!--<link rel="import" href="../polymer-svg-template/polymer-svg-template.html"/>-->
<link rel="import" href="../polymer/polymer.html"/>
<!--<link rel="import" href="svg-container.html" />-->
<!--<link rel="import" href="svg-component.html" />-->

<dom-module id="github-punchcard">
	<template>
		<style>
			.week-day {
				text-align: right;
			}

			/*
			td {
				text-align: center;
			}
			*/

			div {
				margin: auto;
			}
		</style>

		<paper-toast id="message"></paper-toast>

		<!-- https://stackoverflow.com/questions/4840736/easier-way-to-create-circle-div-than-using-an-image -->
		<table>
			<template is="dom-repeat" items="[[punchCard]]" as="day" index-as="d">
				<tr>
					<th class="week-day">[[weekDay(d)]]</th>
					<template is="dom-repeat" items="[[day]]" as="hour">
						<td style="width: [[width]]px; height: [[height]]px;"><div style="background-color: black; border-radius: 50%; width: [[d(hour)]]px; height: [[d(hour)]]px;"></div></td>
					</template>
				</tr>
			</template>
			<tr>
				<th></th>
				<template is="dom-repeat" items='[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23]'>
					<th>[[index]]</th>
				</template>
			</tr>
		</table>

		<!--<svg-container id="SvgContainer" view-box="0 0 400 400">
			<svg-component is="g" id="SomeCircles" transform="translate(40, 40)scale(0.75)">
				<template is="dom-repeat" items="[20, 120, 220, 300]" as="cx">
					<svg-component is="circle" r="25" cx$="{{cx}}" cy="25" stroke="#3e7cd7" stroke-width="5px" fill="rgb(226, 198, 10)"></svg-component>
				</template>
				<svg-component is="rect" x="50" y="20" width="150" height="150" stroke="#a23ed7" stroke-width="10px" fill="rgb(67, 193, 72)"></svg-component>
			</svg-component>
		</svg-container>-->

		<!-- the following works on first load, but not on user and repo change -->
		<!-- https://stackoverflow.com/questions/56402/aligning-text-in-svg -->
		<!--<svg-container id="svgContainer1" view-box="0 0 700 210">
			<svg-component is="g" id="punchCard" transform="translate(25, 25)">
				<template is="dom-repeat" items="[[punchCard]]" as="day" index-as="d">
					<svg-component is="text" x="50" y$="[[y(d)]]" style="text-anchor: end; dominant-baseline: central;">[[weekDay(d)]]</svg-component>
					<template is="dom-repeat" items="[[day]]" as="hour" index-as="h">
						<svg-component is="circle" cx$="[[x(h)]]" cy$="[[y(d)]]" r$="[[r(hour)]]"></svg-component>
					</template>
				</template>
				<template is="dom-repeat" items="[[punchCard.0]]">
					<svg-component is="text" x$="[[x(index)]]" y$="[[y(7)]]" style="text-anchor: middle;">[[index]]</svg-component>
				</template>
			</svg-component>
		</svg-container>-->

		<!--<dom-repeat items="[[punchCard]]" as="day" index-as="d">
			<template>
				<p>1</p>
			</template>
		</dom-repeat>
		<template is="dom-repeat" items='[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23]'>
			[[item]]
		</template>
		<template is="dom-repeat" items="[[punchCard.0]]">
			[[index]]
		</template>-->

		<!-- template doesn't work inside svg elements, https://github.com/Polymer/polymer/issues/1976 -->
		<!--<svg width="210mm" height="297mm">
			<g id="layer1">
				<template is="dom-repeat" items="[[punchCard]]" as="day" index-as="d">
					<text x="100" y="[[y(d)]]" style="text-anchor: end; dominant-baseline: central;">[[weekDay(d)]]</text>
					<template is="dom-repeat" items="[[day]]" as="hour" index-as="h">
						<circle cx="[[x(h)]]" cy="[[y(d)]]" r="[[hour]]"></circle>
					</template>
				</template>
				<template is="dom-repeat" items='[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23]'>
					<text x="[[x(index)]]" y="[[y(7)]]" style="text-anchor: middle;">[[item]]</text>
				</template>
			</g>
		</svg>-->
	</template>
	<script src="../../src/PunchCard.js"></script>
	<script>
		/*
		 * https://github.com/garryyao/polymer-svg-template
		 */
		//PolymerSvgTemplate('github-punchcard');

		class GithubPunchcard extends Polymer.Element {
			static get is() { return "github-punchcard"; }

			static get properties() {
				return {
					user: {
						type: String,
						value: "polymer",
						notify: true,
					},
					repo: {
						type: String,
						value: "polymer",
						notify: true,
					},
				};
			}

			static get observers() {
				return [
					"load(user, repo)",
				];
			}

			ready() {
				super.ready();
				this.punchCard = [
					[],
					[],
					[],
					[],
					[],
					[],
					[],
				];
			}

			load(user, repo) {

				if (!user || !repo) {
					return;
				}

				var self = this;

				this.loadDebouncer = Polymer.Debouncer.debounce(
						this.loadDebouncer,
						Polymer.Async.timeOut.after(1000),
						function() {
							self.$.message.text = "Loading";
							self.$.message.open();

							new PunchCard().load(user, repo).then(function(punchCard) {
								console.log(punchCard);
								self.punchCard = punchCard;

								self.width = 25;
								self.height = 25;
								for (var day of punchCard) {
									for (var hour of day) {
										var d = self.d(hour);
										if (self.height < d) {
											self.height = d;
										}
										if (self.width < d) {
											self.width = d;
										}
									}
								}
								self.$.message.close();
							}).catch(function(message) {
								self.$.message.text = message;
								self.$.message.open();
							});
						});
			}

			weekDay(index) {
				return ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"][index];
			}

			x(index) {
				return 75 + 25 * index;
			}

			y(index) {
				return 25 * index;
			}

			r(hour) {
				return Math.sqrt(hour);
			}

			d(hour) {
				return Math.ceil(this.r(hour) * 2);
			}
		}

		window.customElements.define(GithubPunchcard.is, GithubPunchcard);
	</script>
</dom-module>